name: Hexo Deploy Automatically (with cache)

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy-blog:
    runs-on: ubuntu-latest

    steps:
      - name: Restore Project Cache
        id: project-cache
        uses: actions/cache@v4
        with:
          path: luckyship.github.io
          key: hexo-project-cache

      - name: Clone Project (if cache miss)
        if: steps.project-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/luckyship/luckyship.github.io.git
          cd luckyship.github.io
          git checkout dev
          git submodule update --init --recursive

      - name: Save Project to Cache
        if: steps.project-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: luckyship.github.io
          key: hexo-project-cache

      - name: Setup Node Env
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache Node Modules
        id: node-modules-cache
        uses: actions/cache@v4
        with:
          path: luckyship.github.io/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('luckyship.github.io/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - uses: actions/setup-node@v4
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install Dependencies
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: |
          cd luckyship.github.io
          yarn install

      - name: Deploy Hexo Blog
        env:
          SSH_KEY: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}
        run: |
          cd luckyship.github.io
          export TZ='Asia/Shanghai' 

          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          git config --global user.name 'luckyship'
          git config --global user.email '304093931@qq.com'

          npm run deploy
